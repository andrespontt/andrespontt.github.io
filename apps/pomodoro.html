<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Pomodoro ‚Äî Focus Timer</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0c111c; --bg2:#0b1020; --fg:#e6eefc; --muted:#8aa0c8; --accent:#7dd3fc; --accent2:#34d399; --border:rgba(255,255,255,.12);
      --warn:#fde047; --ok:#86efac; --shadow:0 14px 40px rgba(2,6,23,.22);
    }
    html, body { height: 100%; }
    * { box-sizing: border-box; }
    body{
      margin: 0; color: var(--fg);
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, var(--bg), var(--bg2));
      height: 100dvh; overflow: hidden; /* no scroll */
    }
    .screen{ position:relative; width:100%; height:100dvh; overflow:hidden; }
    /* fixed minimal nav so page never scrolls */
    nav#site-nav{ position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,.25); border:1px solid var(--border); border-radius: 999px; padding: 6px 10px; z-index: 5; backdrop-filter: blur(10px); }
    nav#site-nav ul{ display:flex; gap:8px; margin:0; padding:0; list-style:none; }
    nav#site-nav a{ color:#cfe8ff; text-decoration:none; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; }
    nav#site-nav a[aria-current="page"]{ color:#081a14; background: var(--accent); }

    .main{
      position:absolute; inset:0; display:grid; grid-template-rows: 56px 1fr 56px; padding: 12px 16px calc(16px + env(safe-area-inset-bottom)); gap: 8px;
    }
    .topbar{ display:flex; align-items:center; justify-content:space-between; }
    .ghost{ background: rgba(255,255,255,.08); border:1px solid var(--border); color:var(--fg); border-radius:12px; padding:8px 12px; font-weight:800; text-decoration:none; cursor:pointer; }
    .icon{ width:36px; height:36px; display:grid; place-items:center; border-radius:10px; background: rgba(255,255,255,.08); border:1px solid var(--border); cursor:pointer; }

    .center{ display:grid; place-items:center; }
    .ring{ width:min(86vw, 520px); aspect-ratio:1/1; border-radius:50%; background:
      conic-gradient(var(--accent) calc(var(--pct,0)*1%), rgba(255,255,255,.08) 0);
      display:grid; place-items:center; box-shadow:0 18px 50px rgba(2,6,23,.25); transition: filter .2s ease;
    }
    .ring:active{ filter: brightness(1.05); }
    .ring-inner{ width:78%; height:78%; border-radius:50%; background:#0b142a; border:1px solid var(--border); display:grid; place-items:center; text-align:center; padding:10px; }
    .ring-inner.pulse{ animation: pulse .35s ease; }
    @keyframes pulse { 0%{ transform: scale(1); box-shadow: 0 0 0 0 rgba(125,211,252,.45);} 70%{ transform: scale(.985); box-shadow: 0 0 0 16px rgba(125,211,252,0);} 100%{ transform: scale(1); box-shadow: none; } }
    .time{ font-size: clamp(42px, 15vw, 72px); font-weight: 900; letter-spacing:.5px; }
    .phase{ color: var(--muted); font-weight:800; margin-top:-2px; font-size: clamp(12px, 3.5vw, 14px); }
    .hint{ color: var(--muted); font-size: 12px; margin-top: 6px; transition: color .15s ease; }
    .hint.flash{ color: var(--accent2); }

    .bottombar{ display:flex; align-items:center; justify-content:space-between; }
    .pill{ background:#0a1430; border:1px solid var(--border); border-radius:999px; padding:8px 12px; font-weight:800; color:#c3d7fb; }

    /* Preferences panel (iPhone-like slide) */
    .sheet{ position:absolute; inset:0; background: linear-gradient(180deg, #090f1c, #0b1224); border-left:1px solid var(--border); transform: translateX(100%);
      transition: transform .35s cubic-bezier(.22,.61,.36,1); z-index:6; display:grid; grid-template-rows: 56px 1fr; padding: 12px 16px calc(16px + env(safe-area-inset-bottom)); }
    .sheet.open{ transform: translateX(0); }
    .sheet header{ display:flex; align-items:center; justify-content:space-between; }
    .sheet h2{ font-size: 18px; margin:0; }
    .list{ display:grid; gap: 10px; align-content:start; overflow:auto; padding-bottom: 24px; }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; background:#0c1733; border:1px solid var(--border); border-radius:12px; padding:10px 12px; }
    .row label{ color:#cfe8ff; font-weight:800; }
    .row input, .row select{ appearance:none; border:1px solid var(--border); background:#0f162d; color:var(--fg); padding:10px 12px; border-radius:10px; font-weight:800; min-width:90px; }
    .row .grow{ flex:1 }
    .danger{ background:#2b1f05; border-color:#5c4306; color:#ffe8a3; }
  </style>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2PFGZZBZ0B"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments)};
    gtag('js', new Date());
    gtag('config', 'G-2PFGZZBZ0B');
  </script>
</head>
<body>
  <div class="screen" role="application" aria-label="Pomodoro focus timer">
    <nav id="site-nav">
      <noscript>
        <ul>
          <li><a href="../index.html">Home</a></li>
          <li><a href="../pages/experiments.html">Experiments</a></li>
          <li><a href="../pages/music.html">Music</a></li>
          <li><a href="../pages/bio.html">About Me</a></li>
          <li><a href="type-quest.html">Games</a></li>
          <li><a href="perfect-pitch.html">Perfect Pitch</a></li>
          <li><a href="pomodoro.html">Pomodoro</a></li>
        </ul>
      </noscript>
    </nav>

    <div class="main" id="main">
      <div class="topbar">
        <button id="status" class="ghost" aria-live="polite">Ready</button>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="notif" class="icon" title="Notifications">üîî</button>
          <button id="gear" class="icon" title="Preferences">‚öôÔ∏è</button>
        </div>
      </div>
      <div class="center">
        <button id="ring" class="ring" style="--pct:0" aria-label="Timer ring (tap to start/pause)">
          <div id="ringInner" class="ring-inner">
            <div id="time" class="time">05:00</div>
            <div id="phase" class="phase">Focus</div>
            <div id="hint" class="hint">Tap to start ‚Ä¢ Double-tap to reset</div>
          </div>
        </button>
      </div>
      <div class="bottombar">
        <div class="pill" id="taskpill">Task: <span id="taskLabel">None</span></div>
        <div class="pill">Cycle <span id="cycle">0</span>/<span id="every">4</span></div>
      </div>
    </div>

    <!-- Slide-in preferences sheet -->
    <div class="sheet" id="sheet" aria-hidden="true">
      <header>
        <h2>Preferences</h2>
        <button id="closeSheet" class="icon" title="Close">‚úñÔ∏è</button>
      </header>
      <div class="list">
        <div class="row">
          <label for="taskName" class="grow">Task</label>
          <input id="taskName" class="grow" type="text" placeholder="Optional" />
        </div>
        <div class="row">
          <label for="focusMin">Focus (min)</label>
          <input id="focusMin" type="number" min="1" max="180" />
        </div>
        <div class="row">
          <label for="shortMin">Short Break (min)</label>
          <input id="shortMin" type="number" min="1" max="60" />
        </div>
        <div class="row">
          <label for="longMin">Long Break (min)</label>
          <input id="longMin" type="number" min="1" max="90" />
        </div>
        <div class="row">
          <label for="longEvery">Long every</label>
          <select id="longEvery">
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
        <div class="row">
          <label for="soundToggle">Sound</label>
          <select id="soundToggle">
            <option value="on">On</option>
            <option value="off">Off</option>
          </select>
        </div>
        <div class="row">
          <label for="wakeToggle">Keep Screen Awake</label>
          <select id="wakeToggle">
            <option value="off">Off</option>
            <option value="on">On</option>
          </select>
        </div>
        <div class="row danger">
          <button id="resetProgress" class="ghost danger" style="width:100%">Reset Progress</button>
        </div>
      </div>
    </div>
  </div>

  <script src="../assets/nav.js" defer></script>
  <script>
    const SAVE_KEY = 'pomodoro_state_v1';
    const els = {
      ring: document.getElementById('ring'), ringInner: document.getElementById('ringInner'), time: document.getElementById('time'), phase: document.getElementById('phase'), hint: document.getElementById('hint'),
      status: document.getElementById('status'), cycle: document.getElementById('cycle'), every: document.getElementById('every'),
      gear: document.getElementById('gear'), sheet: document.getElementById('sheet'), closeSheet: document.getElementById('closeSheet'),
      taskPill: document.getElementById('taskpill'), taskLabel: document.getElementById('taskLabel'),
      focusMin: document.getElementById('focusMin'), shortMin: document.getElementById('shortMin'), longMin: document.getElementById('longMin'), longEvery: document.getElementById('longEvery'),
      soundToggle: document.getElementById('soundToggle'), wakeToggle: document.getElementById('wakeToggle'), taskName: document.getElementById('taskName'),
      resetProgress: document.getElementById('resetProgress'), notif: document.getElementById('notif')
    };

    // State
    let audioCtx = null; let muted = false; let wakeLock = null; let wakeWanted = false;
    let tickHandle = null; let lastTap = 0;
    const nowMs = () => Date.now();
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
    function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }
    function tone(freq=600, dur=.12, type='sine', vol=.22){ if(muted) return; try{ ensureAudio(); const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type=type; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination); const t=audioCtx.currentTime; g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(vol,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+dur); o.start(t); o.stop(t+dur+.02);}catch(e){} }
    function chime(){ tone(523.25,.12,'sine',.22); setTimeout(()=>tone(659.25,.12,'sine',.22),140); setTimeout(()=>tone(784,.14,'sine',.22),300); }
    function vibrate(pat=[120,80,120]){ try{ if(navigator.vibrate) navigator.vibrate(pat); }catch(e){} }
    async function requestWake(){ if(!('wakeLock' in navigator)) return; try{ wakeLock = await navigator.wakeLock.request('screen'); wakeLock.addEventListener('release', ()=>{ wakeLock=null; }); }catch(e){} }
    function releaseWake(){ try{ if(wakeLock) { wakeLock.release(); wakeLock=null; } }catch(e){} }

    const state = {
      settings: { focusMin:5, shortMin:2, longMin:10, longEvery:4, notifs:false, currentTask:'', keepAwake:false },
      running:false, phase:'focus', startAt:0, endAt:0, durSec:5*60, doneCycles:0,
      history: [], tasks:{}
    };

    function save(){ try{ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }catch(e){} }
    function load(){ try{ const raw = localStorage.getItem(SAVE_KEY); if(raw){ const s=JSON.parse(raw); if(s.settings) state.settings={...state.settings,...s.settings}; ['running','phase','startAt','endAt','durSec','doneCycles'].forEach(k=>{ if(s[k]!==undefined) state[k]=s[k]; }); if(Array.isArray(s.history)) state.history=s.history.slice(-2000); if(s.tasks) state.tasks=s.tasks; } }catch(e){} }

    function msLeft(){ return Math.max(0, state.endAt - nowMs()); }
    function secsLeft(){ return Math.ceil(msLeft()/1000); }
    function fmtClock(totalSec){ const m=Math.floor(totalSec/60), s=totalSec%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

    function setPhase(next){ state.phase=next; const mins=(next==='focus')?state.settings.focusMin:(next==='short')?state.settings.shortMin:state.settings.longMin; state.durSec=Math.max(1,Math.round(mins*60)); state.startAt=0; state.endAt=0; state.running=false; updateUI(); save(); }
    function start(){ if(state.running) return; const left=state.durSec; state.startAt=nowMs(); state.endAt=state.startAt+left*1000; state.running=true; els.status.textContent='Running'; if(!tickHandle) tickHandle=setInterval(tick,250); ensureAudio(); if(state.settings.keepAwake) requestWake(); }
    function pause(){ if(!state.running) return; state.durSec=secsLeft(); state.running=false; els.status.textContent='Paused'; save(); releaseWake(); }
    function resetTimer(){ state.startAt=0; state.endAt=0; state.running=false; const mins=(state.phase==='focus')?state.settings.focusMin:(state.phase==='short')?state.settings.shortMin:state.settings.longMin; state.durSec=Math.round(mins*60); els.status.textContent='Ready'; updateUI(); save(); }
    function skip(){ completePhase(true); }

    function notify(title, body){ if(!state.settings.notifs) return; try{ if(Notification.permission==='granted'){ const n=new Notification(title,{ body }); setTimeout(()=>n.close&&n.close(),5000);} }catch(e){} }

    function completePhase(skipped=false){ const elapsed=(state.running?Math.round((state.endAt-state.startAt)/1000):state.durSec); state.history.push({ts:Date.now(),phase:state.phase,sec:elapsed,skipped});
      // Task accounting (only count completed focus)
      if(state.phase==='focus' && !skipped){ const name=(state.settings.currentTask||'').trim(); if(name){ const t=state.tasks[name]||{focusCount:0,focusSec:0,lastAt:0}; t.focusCount+=1; t.focusSec+=elapsed; t.lastAt=Date.now(); state.tasks[name]=t; } chime(); vibrate(); notify('Focus done ‚úÖ', `Break ${state.settings.shortMin} min`); state.doneCycles+=1; }
      if(state.phase!=='focus'){ notify('Break over ‚è∞','Back to focus'); tone(440,.15); setTimeout(()=>tone(660,.12),160); }
      // next phase
      if(state.phase==='focus'){ const next=(state.doneCycles % state.settings.longEvery===0)?'long':'short'; setPhase(next); } else { setPhase('focus'); }
      save(); updateUI(); }

    function tick(){ if(!state.running){ clearInterval(tickHandle); tickHandle=null; return; } const left=secsLeft(); if(left<=0){ state.running=false; completePhase(false); return; } state.durSec=left; updateUI(false); }

    function updateUI(updateRing=true){ const total=(state.phase==='focus')?state.settings.focusMin*60:(state.phase==='short')?state.settings.shortMin*60:state.settings.longMin*60; const left=state.durSec; els.time.textContent=fmtClock(left); els.phase.textContent=(state.phase==='focus'?'Focus':(state.phase==='short'?'Short Break':'Long Break'));
      if(updateRing){ const pct=Math.max(0,Math.min(1,1-(left/total))); els.ring.style.setProperty('--pct',(pct*100).toFixed(2)); }
      els.every.textContent=String(state.settings.longEvery); els.cycle.textContent=String(state.doneCycles % state.settings.longEvery); els.taskLabel.textContent=(state.settings.currentTask||'None'); updateHint(); }

    function updateHint(){ els.hint.textContent = state.running ? 'Tap to pause ‚Ä¢ Double-tap to reset' : 'Tap to start ‚Ä¢ Double-tap to reset'; }
    function flash(msg){ const old = els.hint.textContent; els.hint.textContent = msg; els.hint.classList.add('flash'); setTimeout(()=>{ els.hint.classList.remove('flash'); updateHint(); }, 800); }
    function pulseRing(){ try{ els.ringInner.classList.remove('pulse'); void els.ringInner.offsetWidth; els.ringInner.classList.add('pulse'); }catch(e){} }

    // Interaction: tap ring to start/pause; double-tap to reset
    els.ring.addEventListener('click', ()=>{ const now=Date.now(); if(now-lastTap<300){ lastTap=0; resetTimer(); flash('Reset'); pulseRing(); vibrate([20]); return; } lastTap=now; if(state.running){ pause(); flash('Paused'); } else { start(); flash('Started'); } pulseRing(); vibrate([10]); });

    // Sheet open/close
    function openSheet(){ els.sheet.classList.add('open'); els.sheet.setAttribute('aria-hidden','false'); }
    function closeSheet(){ els.sheet.classList.remove('open'); els.sheet.setAttribute('aria-hidden','true'); }
    els.gear.addEventListener('click', openSheet); els.closeSheet.addEventListener('click', closeSheet);

    // Prefs wiring
    function applyInputsToSettings(){ state.settings.focusMin=clamp(Number(els.focusMin.value)||5,1,180); state.settings.shortMin=clamp(Number(els.shortMin.value)||2,1,60); state.settings.longMin=clamp(Number(els.longMin.value)||10,1,90); state.settings.longEvery=clamp(Number(els.longEvery.value)||4,2,12); state.settings.currentTask=(els.taskName.value||'').trim(); state.settings.keepAwake = (els.wakeToggle.value==='on'); muted = (els.soundToggle.value==='off'); save(); if(state.phase==='focus' || state.phase==='short' || state.phase==='long'){ resetTimer(); } updateUI(); }
    ['change','input'].forEach(evt=>{ [els.focusMin,els.shortMin,els.longMin,els.longEvery,els.taskName,els.soundToggle,els.wakeToggle].forEach(c=>c.addEventListener(evt, applyInputsToSettings)); });

    // Notifications toggle
    els.notif.addEventListener('click', async ()=>{ try{ if('Notification' in window){ if(Notification.permission==='granted'){ state.settings.notifs=!state.settings.notifs; els.status.textContent= state.settings.notifs? 'Notifications on' : 'Notifications off'; } else { const perm=await Notification.requestPermission(); state.settings.notifs=(perm==='granted'); els.status.textContent= state.settings.notifs? 'Notifications on' : 'Notifications blocked'; } save(); } else { els.status.textContent='No notifications; using sound/vibration'; } }catch(e){ els.status.textContent='Notification error'; }
    });

    // Reset progress
    els.resetProgress.addEventListener('click', ()=>{ if(confirm('Reset all Pomodoro progress?')){ localStorage.removeItem(SAVE_KEY); state.settings={ focusMin:5, shortMin:2, longMin:10, longEvery:4, notifs:false, currentTask:'', keepAwake:false }; state.running=false; state.phase='focus'; state.doneCycles=0; state.history=[]; state.tasks={}; muted=false; wakeWanted=false; releaseWake(); resetTimer(); save(); els.status.textContent='Progress cleared'; }});

    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible'){ tone(523.25,.05); } });
    ['click','touchstart','keydown'].forEach(evt=>{ window.addEventListener(evt, ()=>{ try{ ensureAudio(); }catch(e){} }, { once:true }); });

    // Init
    load();
    // set defaults into inputs
    els.focusMin.value=String(state.settings.focusMin); els.shortMin.value=String(state.settings.shortMin); els.longMin.value=String(state.settings.longMin); els.longEvery.value=String(state.settings.longEvery); els.taskName.value=state.settings.currentTask||''; els.every.textContent=String(state.settings.longEvery); els.soundToggle.value= muted? 'off' : 'on'; els.wakeToggle.value = state.settings.keepAwake? 'on':'off';
    if(state.running){ const left=secsLeft(); if(left<=0){ state.running=false; completePhase(false); } else { state.durSec=left; els.status.textContent='Running'; tickHandle=setInterval(tick,250); } }
    else if(state.startAt && state.endAt){ state.durSec=Math.max(1,Math.round((state.endAt-state.startAt)/1000)); }
    else { resetTimer(); }
    updateUI();
  </script>
</body>
</html>
